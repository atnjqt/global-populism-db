<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Populism Database - Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #e63946 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: rgba(0, 0, 0, 0.75);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-icon {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            filter: brightness(0) invert(1);
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
            margin: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 0.9rem;
        }

        select, input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .update-btn {
            padding: 0.5rem 1.5rem;
            background: linear-gradient(135deg, #ff6b35 0%, #e63946 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(230, 57, 70, 0.3);
        }

        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.5);
            background: linear-gradient(135deg, #e63946 0%, #ff6b35 100%);
        }

        .update-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .update-btn.loading {
            position: relative;
            color: transparent;
        }

        .update-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-bar {
            display: flex;
            gap: 2rem;
            padding: 1rem 0;
            border-top: 1px solid #eee;
            margin-top: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e63946;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .map-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .map-and-legend {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .map-wrapper {
            flex: 1;
        }

        .legend-wrapper {
            width: 250px;
        }

        #map {
            height: 600px;
            border-radius: 4px;
        }

        .legend {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 1rem;
        }

        .legend h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #333;
        }

        .legend-scale {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .legend-color {
            width: 40px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .legend-label {
            font-size: 0.85rem;
            color: #666;
        }

        .info-panel {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-panel h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .country-info {
            display: none;
        }

        .country-info.active {
            display: block;
        }

        .country-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ff6b35;
        }

        .country-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e63946;
        }

        .timeline {
            margin-top: 1rem;
        }

        .timeline-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            border-left: 4px solid #ff6b35;
            border-radius: 4px;
        }

        .leader-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .party-name {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .term-info {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .score-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .score-label {
            font-size: 0.85rem;
            min-width: 100px;
        }

        .score-fill {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill-inner {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #e63946);
            transition: width 0.3s;
        }

        .score-value {
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .map-and-legend {
                flex-direction: column;
            }

            .legend-wrapper {
                width: 100%;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .header-icon {
                width: 48px;
                height: 48px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <img src="https://www.svgrepo.com/show/387676/globe.svg" alt="Globe" class="header-icon">
            <div class="header-text">
                <h1>Global Populism Database</h1>
                <p>Interactive visualization of populist rhetoric across world leaders and time periods</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="yearStart">Start Year</label>
                    <input type="number" id="yearStart" min="1934" max="2026" value="2000">
                </div>
                <div class="control-group">
                    <label for="yearEnd">End Year</label>
                    <input type="number" id="yearEnd" min="1934" max="2026" value="2026">
                </div>
                <div class="control-group">
                    <label for="speechType">Speech Type</label>
                    <select id="speechType">
                        <option value="total">All Speech Types</option>
                        <option value="campaign">Campaign Speeches</option>
                        <option value="famous">Famous Speeches</option>
                        <option value="international">International Speeches</option>
                        <option value="ribbon">Ribbon-Cutting Speeches</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button id="updateBtn" class="update-btn" onclick="updateMap()">
                        Update Map
                    </button>
                </div>
            </div>
            
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="statCountries">-</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statLeaders">-</div>
                    <div class="stat-label">Leaders</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statAvgPopulism">-</div>
                    <div class="stat-label">Avg Populism Score</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statRecords">-</div>
                    <div class="stat-label">Total Records</div>
                </div>
            </div>
        </div>

        <div class="map-and-legend">
            <div class="map-wrapper">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
            
            <div class="legend-wrapper">
                <div class="legend">
                    <h3>Populism Score Scale</h3>
                    <div class="legend-scale">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffffcc;"></div>
                            <div class="legend-label">0.0 - 0.2 (Very Low)</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffeda0;"></div>
                            <div class="legend-label">0.2 - 0.4</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fed976;"></div>
                            <div class="legend-label">0.4 - 0.6</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #feb24c;"></div>
                            <div class="legend-label">0.6 - 0.8</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fd8d3c;"></div>
                            <div class="legend-label">0.8 - 1.0</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fc4e2a;"></div>
                            <div class="legend-label">1.0 - 1.2</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e31a1c;"></div>
                            <div class="legend-label">1.2 - 1.5</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #bd0026;"></div>
                            <div class="legend-label">1.5 - 1.8</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #800026;"></div>
                            <div class="legend-label">1.8 - 2.0 (Very High)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div id="defaultInfo">
                <h3>Country Details</h3>
                <p style="color: #666;">Click on a country to see detailed information about leaders and populism scores over time.</p>
            </div>
            <div id="countryInfo" class="country-info">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let map;
        let currentData = [];
        let markers = [];

        // Country coordinates (approximate centers)
        const countryCoords = {
            "Albania": [41.3275, 19.8187], "Argentina": [-38.4161, -63.6167], "Armenia": [40.0691, 45.0382],
            "Australia": [-25.2744, 133.7751], "Austria": [47.5162, 14.5501], "Azerbaijan": [40.1431, 47.5769],
            "Belarus": [53.7098, 27.9534], "Bolivia": [-16.2902, -63.5887], "Brazil": [-14.2350, -51.9253],
            "Bulgaria": [42.7339, 25.4858], "Canada": [56.1304, -106.3468], "Chile": [-35.6751, -71.5430],
            "Colombia": [4.5709, -74.2973], "Costa Rica": [9.7489, -83.7534], "Croatia": [45.1000, 15.2000],
            "Czech Republic": [49.8175, 15.4730], "Denmark": [56.2639, 9.5018], "Ecuador": [-1.8312, -78.1834],
            "Finland": [61.9241, 25.7482], "France": [46.2276, 2.2137], "Georgia": [42.3154, 43.3569],
            "Germany": [51.1657, 10.4515], "Greece": [39.0742, 21.8243], "Hungary": [47.1625, 19.5033],
            "India": [20.5937, 78.9629], "Indonesia": [-0.7893, 113.9213], "Iran": [32.4279, 53.6880],
            "Israel": [31.0461, 34.8516], "Italy": [41.8719, 12.5674], "Japan": [36.2048, 138.2529],
            "Kazakhstan": [48.0196, 66.9237], "Kenya": [-0.0236, 37.9062], "Kyrgyzstan": [41.2044, 74.7661],
            "Mexico": [23.6345, -102.5528], "Netherlands": [52.1326, 5.2913], "New Zealand": [-40.9006, 174.8860],
            "Nicaragua": [12.8654, -85.2072], "Norway": [60.4720, 8.4689], "Pakistan": [30.3753, 69.3451],
            "Peru": [-9.1900, -75.0152], "Philippines": [12.8797, 121.7740], "Poland": [51.9194, 19.1451],
            "Romania": [45.9432, 24.9668], "Russia": [61.5240, 105.3188], "Serbia": [44.0165, 21.0059],
            "Slovakia": [48.6690, 19.6990], "Slovenia": [46.1512, 14.9955], "South Africa": [-30.5595, 22.9375],
            "South Korea": [35.9078, 127.7669], "Spain": [40.4637, -3.7492], "Sweden": [60.1282, 18.6435],
            "Switzerland": [46.8182, 8.2275], "Taiwan": [23.6978, 120.9605], "Thailand": [15.8700, 100.9925],
            "Turkey": [38.9637, 35.2433], "Uganda": [1.3733, 32.2903], "Ukraine": [48.3794, 31.1656],
            "United Kingdom": [55.3781, -3.4360], "United States": [37.0902, -95.7129], "Uruguay": [-32.5228, -55.7658],
            "Venezuela": [6.4238, -66.5897], "Zambia": [-13.1339, 27.8493], "Zimbabwe": [-19.0154, 29.1549],
            "El Salvador": [13.7942, -88.8965], "Guatemala": [15.7835, -90.2308], "Honduras": [15.2000, -86.2419],
            "Moldova": [47.4116, 28.3699], "North Macedonia": [41.6086, 21.7453], "Panama": [8.5380, -80.7821],
            "Paraguay": [-23.4425, -58.4438], "Portugal": [39.3999, -8.2245], "Senegal": [14.4974, -14.4524]
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Get color for populism score
        function getColor(score) {
            const colors = ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026'];
            const index = Math.min(Math.floor(score * 4), colors.length - 1);
            return colors[index];
        }

        // Update map with data
        function updateMapMarkers(data) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add new markers
            data.forEach(item => {
                const coords = countryCoords[item.country];
                if (!coords) return;

                const color = getColor(item.avg_populism);
                const radius = Math.max(5, Math.min(20, 5 + item.avg_populism * 10));

                const marker = L.circleMarker(coords, {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <strong>${item.country}</strong><br>
                    Avg Populism: ${item.avg_populism.toFixed(2)}<br>
                    Region: ${item.region}<br>
                    Leader Terms: ${item.num_terms}
                `);

                marker.on('click', () => loadCountryDetails(item.country));
                
                marker.addTo(map);
                markers.push(marker);
            });
        }

        // Load country timeline details
        async function loadCountryDetails(country) {
            try {
                const response = await fetch(`${API_BASE}/api/timeline/${encodeURIComponent(country)}`);
                const data = await response.json();

                document.getElementById('defaultInfo').style.display = 'none';
                const infoDiv = document.getElementById('countryInfo');
                infoDiv.className = 'country-info active';

                let html = `
                    <div class="country-header">
                        <div class="country-name">${data.country}</div>
                        <div>${data.count} Leader Terms</div>
                    </div>
                    <div class="timeline">
                `;

                data.timeline.forEach(term => {
                    html += `
                        <div class="timeline-item">
                            <div class="leader-name">${term.leader}</div>
                            <div class="party-name">${term.party || 'Independent'}</div>
                            <div class="term-info">Term ${term.term}: ${term.year_start} - ${term.year_end}</div>
                            
                            <div class="score-bar">
                                <div class="score-label">Total:</div>
                                <div class="score-fill">
                                    <div class="score-fill-inner" style="width: ${(term.total_populism / 2) * 100}%"></div>
                                </div>
                                <div class="score-value">${term.total_populism.toFixed(2)}</div>
                            </div>
                    `;

                    if (term.campaign !== null) {
                        html += `
                            <div class="score-bar">
                                <div class="score-label">Campaign:</div>
                                <div class="score-fill">
                                    <div class="score-fill-inner" style="width: ${(term.campaign / 2) * 100}%"></div>
                                </div>
                                <div class="score-value">${term.campaign.toFixed(2)}</div>
                            </div>
                        `;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
                infoDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading country details:', error);
            }
        }

        // Update map with current filters
        async function updateMap() {
            const btn = document.getElementById('updateBtn');
            const yearStart = document.getElementById('yearStart').value;
            const yearEnd = document.getElementById('yearEnd').value;
            const speechType = document.getElementById('speechType').value;

            // Add loading state
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                const params = new URLSearchParams({
                    speech_type: speechType
                });
                if (yearStart) params.append('year_start', yearStart);
                if (yearEnd) params.append('year_end', yearEnd);

                const response = await fetch(`${API_BASE}/api/map-data?${params}`);
                const data = await response.json();

                currentData = data.map_data;
                updateMapMarkers(currentData);

                // Update stats
                const avgPopulism = currentData.reduce((sum, d) => sum + d.avg_populism, 0) / currentData.length;
                document.getElementById('statCountries').textContent = currentData.length;
                document.getElementById('statAvgPopulism').textContent = avgPopulism.toFixed(2);

            } catch (error) {
                console.error('Error updating map:', error);
                alert('Error loading map data. Please check the console for details.');
            } finally {
                // Remove loading state
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Load summary statistics
        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/api/summary`);
                const data = await response.json();

                document.getElementById('statRecords').textContent = data.total_records;
                document.getElementById('statLeaders').textContent = data.total_leaders;

            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        // Initialize
        window.onload = () => {
            initMap();
            loadSummary();
            updateMap();
        };
    </script>
</body>
</html>
